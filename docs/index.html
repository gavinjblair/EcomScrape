<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EcomScrape Products</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --muted: #475569;
      --accent: #2563eb;
      --accent-2: #10b981;
      --warning-bg: #fff7e6;
      --warning-text: #9a5b00;
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 24px; font-family: "Inter", Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    h1 { margin: 0; font-size: 26px; letter-spacing: -0.2px; }
    nav a { margin-left: 12px; color: var(--accent); text-decoration: none; font-weight: 600; }
    nav a:hover { text-decoration: underline; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: 0 8px 24px rgba(15, 23, 42, 0.04); }
    .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; }
    label { font-weight: 600; font-size: 13px; color: var(--muted); display: block; margin-bottom: 4px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: #fff; }
    .actions { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
    button { padding: 10px 14px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.05s ease, box-shadow 0.1s ease; }
    button:active { transform: translateY(1px); }
    .primary { background: var(--accent); color: #fff; box-shadow: 0 8px 16px rgba(37, 99, 235, 0.18); }
    .secondary { background: var(--panel); color: var(--text); border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; background: var(--panel); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; font-size: 14px; }
    th { background: #f8fafc; color: var(--muted); text-transform: uppercase; letter-spacing: 0.4px; font-size: 12px; }
    tr:hover td { background: #f8fafc; }
    .summary { margin-top: 10px; font-weight: 700; color: var(--muted); }
    .message { margin-top: 12px; padding: 12px 14px; background: var(--warning-bg); color: var(--warning-text); border: 1px solid #f4c768; border-radius: 10px; }
    .meta { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; color: var(--muted); font-weight: 600; }
    @media (max-width: 640px) { header { flex-direction: column; align-items: flex-start; gap: 8px; } }
  </style>
</head>
<body>
  <header>
    <h1>EcomScrape Products</h1>
    <nav>
      <a href="/charts">Charts</a>
    </nav>
  </header>

  <div class="card" style="margin-bottom:16px;">
    <div class="controls">
      <div>
        <label for="minPrice">Min price</label>
        <input type="number" id="minPrice" step="0.01" placeholder="e.g. 5" />
      </div>
      <div>
        <label for="maxPrice">Max price</label>
        <input type="number" id="maxPrice" step="0.01" placeholder="e.g. 50" />
      </div>
      <div>
        <label for="category">Category</label>
        <select id="category">
          <option value="">All categories</option>
        </select>
      </div>
      <div class="actions">
        <button id="loadBtn" class="primary">Load products</button>
        <button id="resetBtn" class="secondary">Reset filters</button>
      </div>
    </div>
    <div class="meta">
      <span id="dataInfo"></span>
      <span id="generatedAt"></span>
    </div>
  </div>

  <div id="message" class="message" style="display:none;"></div>

  <table id="productsTable" style="display:none;">
    <thead>
      <tr>
        <th>Title</th>
        <th>Category</th>
        <th>Price</th>
        <th>Rating</th>
        <th>Availability</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const categorySelect = document.getElementById('category');
    const minPriceInput = document.getElementById('minPrice');
    const maxPriceInput = document.getElementById('maxPrice');
    const messageBox = document.getElementById('message');
    const dataInfo = document.getElementById('dataInfo');
    const generatedAt = document.getElementById('generatedAt');
    const table = document.getElementById('productsTable');
    const tbody = table.querySelector('tbody');

    function formatPrice(product) {
      // Prefer current price, fall back to original price, otherwise show dash.
      const price = product.price_current ?? product.price_original;
      return price !== null && price !== undefined ? price : '-';
    }

    function setMessage(text) {
      // Toggle banner for errors or empty-data guidance.
      messageBox.style.display = text ? 'block' : 'none';
      messageBox.textContent = text || '';
    }

    function populateCategories(products) {
      // Build category options from the data to avoid hard-coding values.
      const cats = Array.from(new Set(products.map(p => p.category || 'unknown'))).sort();
      categorySelect.innerHTML = '<option value=\"\">All categories</option>';
      cats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    async function fetchProducts() {
      // Call the API with optional filters derived from the form controls.
      const params = new URLSearchParams();
      if (minPriceInput.value) params.set('min_price', minPriceInput.value);
      if (maxPriceInput.value) params.set('max_price', maxPriceInput.value);
      if (categorySelect.value) params.set('category', categorySelect.value);

      const url = params.toString() ? `/products?${params.toString()}` : '/products';
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error('Failed to load products');
      }
      return res.json();
    }

    function render(products, meta) {
      // Render table rows and supporting meta info.
      tbody.innerHTML = '';
      if (!products || products.length === 0) {
        table.style.display = 'none';
        setMessage('No product data available. Run the scraper, e.g.: ecomscrape -c configs/books_toscrape.yaml -f json');
        dataInfo.textContent = '';
        generatedAt.textContent = meta.generated_at ? `Data generated at: ${meta.generated_at}` : '';
        return;
      }
      setMessage('');
      table.style.display = 'table';
      products.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.title || p.name || ''}</td>
          <td>${p.category || '-'}</td>
          <td>${formatPrice(p)}</td>
          <td>${p.rating ?? '-'}</td>
          <td>${p.availability || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
      dataInfo.textContent = `${products.length} product(s) displayed.`;
      generatedAt.textContent = meta.generated_at ? `Data generated at: ${meta.generated_at}` : '';
    }

    async function loadAndRender(initialLoad = false) {
      // Wrapper to fetch, populate categories on first pass, and render the view.
      try {
        const data = await fetchProducts();
        if (initialLoad) {
          populateCategories(data.products || []);
        }
        render(data.products || [], data);
      } catch (err) {
        setMessage(err.message);
        table.style.display = 'none';
        dataInfo.textContent = '';
        generatedAt.textContent = '';
      }
    }

    document.getElementById('loadBtn').addEventListener('click', () => loadAndRender(false));
    document.getElementById('resetBtn').addEventListener('click', () => {
      minPriceInput.value = '';
      maxPriceInput.value = '';
      categorySelect.value = '';
      loadAndRender(false);
    });

    // Auto-load on page ready
    loadAndRender(true);
  </script>
</body>
</html>
